<{include file='Comon/header.html'}>
<style type="text/css">
.pay{color:#888888;background: #F5F5F9;}
.pay .weui_cells_checkbox .weui_check{border:1px solid #888888;}
.pay .weui_cells_checkbox .weui_check:checked + .weui_icon_checked:before{content: '\EA08';}
.pay .weui_icon_waiting_circle:before{color:#888888;font-size: 1.64285714rem;margin-top: -0.0714285714285714rem;}
.payWay{background: #FFF;}
.order_info_list{width: 4.928571428571429rem;}
.pay .weui_msg{padding:0.7142rem 0;}
.moreWay{padding:0.3571rem 1.071rem;}
.pay .weui_media_box.weui_media_appmsg .weui_media_hd{width: 3.321rem;height: 3.321rem;}
.weui_media_box{padding:0.7142857142857143rem 1.071rem;}
#agreementBox{position: absolute;width: 100%;height: 100%;z-index: 1000;top:0;left:0;background: #efeef3;display: none;}
#agreementBox .weui_msg_title{text-align: center;/*margin-top: 21px;*/font-size: 1.428571rem;color: #000000;}
#agreementBox .weui_msg_desc{/*text-indent:2em;*/padding:0.9285rem 1.5714rem;line-height: 20px;font-size: 1rem;}
#agreementBox .arg_btn{position: fixed;background: #FFF;bottom:0;width: 100%;padding:0.7142857142857143rem 1.071428571428571rem;box-sizing:border-box;}
/*////////////////////////////新加样式//////////////////////////////////////////////*/
.weui_cell table tr th,.weui_cell table tr td{font-size: 1rem;padding-bottom: 1.21428rem;}
.pay .weui_msg{padding-top: 0;}
.weui_msg .weui_msg_title{font-size: 2.07142rem;color: #000000;}
.weui_media_box .weui_media_desc span{font-size: 1.071428rem;}
.weui_media_bd  {font-size: 1.07142rem;}
.weui_icon_waiting_circle{padding-right: 0.428571rem;}
.weui_media_box .weui_media_title{font-size: 1.071428rem!important;}
.weui_media_bd .weui_media_desc_size, .weui_panel_bd .weui_media_desc_size{font-size: 0.857142rem!important;}
.weui_cell_primary p{font-size: 0.85714rem;}
.weui_cell_primary .weui_cell_primary_zffontsize{font-size: 1.1428571rem;font-weight: normal;}
.weui_cell_primary a{color: #00AAEE;}
.weui_cell_bgcolor{background:#F5F5F9;padding-top: 0px;}
.weui_cells:after{display: none;}
.moreWay{font-size: 1rem;margin-bottom: 4rem;}
.moreWay a{color: #556F94;}
._xmfu{float: left;}
.weui_media_text:before{left:0;}
.weui_media_box:after{content: '';width: 100%;height: 1px;color: red;position: absolute;}
.weui_msg{padding-top: 1.428571428571429rem;background: #FFFFFF;}
.weui_msg .weui_icon_area{margin-bottom: 1.071428571428571rem;}
.weui_msg .weui_msg_title{margin-bottom: 0.7142857142857143rem;line-height: 17px;}
.weui_msg .weui_msg_desc{font-size: 1.14285rem;padding-bottom: 0.3571428571428571rem;}
/*.weui_msg .weui_text_area{margin-bottom: 3.78571rem;}*/
.msg_pad{padding: 0;position: relative;margin-bottom: 0;}
.weui_cell table{text-align: left;font-weight: normal;}
.weui_cell table th{font-weight: normal;}
.weui_cell table td{color: #000000;}
.weui_media_text:after{content: '';position: absolute;border-bottom: 1px solid #E5E5E5;bottom: 0px;left: 0;}
.zffs_kuang:after{content: '';position: absolute;border-bottom: 1px solid #E5E5E5;bottom: 0px;left: 0;width: 100%;}  
/*.weui_media_appmsg:before{content: '';position: absolute;border-bottom: 1px solid #E5E5E5;bottom: 0px;left: 0;}*/
/*.color-b{font-weight: normal;}*/
.pay_kuang:after{border-bottom: 0px solid;}
.wx_kuang:after{content: '';position: absolute;border-bottom: 1px solid #E5E5E5;/*bottom: 12.71428571rem;*/left: 0;width: 100%;}
/*.weui_media_box:before{content: '';height: 1px;width: 100%;background: #E5E5E5;display: block;}*/
.weui_cells_checkbox .weui_icon_checked:before{font-size: 1.1428571428571rem;}
.pay .weui_cells_checkbox .weui_check:checked + .weui_icon_checked:before{font-size: 1.1428571428571rem;}
.color_b{font-weight: normal;}
/*.weui_cells_checkbox .chek_k{border: 1px solid #E5E5E5;padding: 0 0 0 0;width: 1rem;height: 1rem;border-radius: 0.2142857rem;margin-right: 0.5rem;}*/
.weui_cells_checkbox .weui_icon_checked:before{content: '';}
#countdown{color:#FB6165;}
/*//////////////////////////////////////////支付宝样式修改///////////////////////////////////////////////////////*/
.pay .weui_cells_checkbox .weui_check:checked + .weui_icon_checked:before{content: '';display: none;}
.weui_cells_checkbox{background: #F5F5F9;}
.weui_cell_primary p{font-size: 1rem;color: #000000;}
.weui_cell:before{display: none;}
.weui_check_label_pad{padding: 1.428571428571429rem 1.071428571428571rem;}
.pay_question{width: 100%;text-align: center;display: block;color: #00AAEE!important;font-size: 1rem;background: #F5F5F9;}
.weui_btn_dialog.primary{color: #00AAEE;font-size: 1.142857142857143rem;}
.payForm{padding-bottom: 6.125rem;}
.weui_icon_msg:before{width:4.285714285714286rem;height: 4.285714285714286rem;content: '';background: url(/static/images/feedback_icon.png) no-repeat;background-size: 4.285714285714286rem;}
.weui_msg .weui_text_area{padding: 0 2.571428571428571rem 3rem;margin-bottom: 1.785714285714286rem;}
.weui_btn_default{background: #FFFFFF;}
.weui_extra_area{position:relative;}
#agreementBox .weui_msg_desc span{color: #000000;}
.weui_btn_area{margin: 1.171428571428571rem 1.071428571428571rem 0.5remem;}
.weui_extra_area a{color: #00AAEE;}
.weui_extra_area{margin-bottom: 22.78571428571429rem;}
.weui_dialog{width: 72%;}
._xmfu_wid{width: 4.928571428571429rem;}
</style>
<title>支付订单</title>
</head>
<body>
<{if $price.paystats == 5}>
<div class="pay wrap">
    <div class="order_info weui_cells ">
        <div class="weui_cell">
            <div class="weui_cell_bd weui_cell_primary">
                <p class="color_b weui_cell_primary_zffontsize">订单信息</p>
            </div>
        </div>
        <div class="weui_cell">
            <table>
                <tr>
                    <th class="order_info_list">报名赛事:</th>
                    <td><{$price.m_name}></td>
                </tr>
                <tr>
                    <th class="_xmfu _xmfu_wid">服务项目:</th>
                    <td><{$meal}></td>
                </tr>
                <tr>
                    <th class="_xmfu_wid">订单编号:</th>
                    <td><{$price.orderid}></td>
                </tr>
            </table>
        </div>
        <div class="weui_msg"style="padding-bottom: 1.5rem;">
            <p class="weui_msg_desc color_b">支付金额:</p>
            <!--<h2 class="weui_msg_title"style="margin-bottom:0 ;">￥<{intval($price.payprice)}></h2>--> 
            <h2 class="weui_msg_title"style="margin-bottom:0 ;">￥<{$price.payprice}></h2> 
        </div>
        <div class="weui_media_box weui_media_text">
            <p class="weui_media_desc"><i class="weui_icon_waiting_circle"></i>已锁定名额，<i id="countdown"><{substr($price.pay_deadline,11,8)}></i> 内未支付名额将自动释放</p>
        </div>
    </div>
    
    <form action="/PayResult/AliPay" id="payForm" style="margin-bottom: 4.285714285714286rem;">
    <input size="30" name="WIDout_trade_no" value="<{$price.orderid}>"  type="hidden"/>
    <div class="weui_cells weui_cells_radio payWay">
        <!--///////////////////////////////////////////////-->
        <!--<div class="weui_cell zffs_kuang">
            <div class="weui_cell_bd weui_cell_primary">
                <p class="color_b weui_cell_primary_zffontsize">支付方式</p>
            </div>
        </div>-->
        <!--<div class="weui_panel_bd wx_kuang">
            <label href="javascript:void(0);" class="weui_media_box weui_media_appmsg" for="course2">
                <div class="weui_media_hd appicon weixin"></div>
                <div class="weui_media_bd">
                    <h4 class="weui_media_title color_b">微信支付</h4>
                    <p class="weui_media_desc weui_media_desc_size">推荐已安装微信的用户使用</p>
                </div>
                <div class="weui_cell_ft">
                    <input type="radio" class="weui_check" value="wxpay"  name="payway" id="course2" checked="checked">
                    <span class="weui_icon_checked"></span>
                </div>
            </label>
             <label href="javascript:void(0);" class="weui_media_box weui_media_appmsg" for="course1">
    <div class="weui_media_hd appicon zhifubao"></div>
    <div class="weui_media_bd">
        <h4 class="weui_media_title color_b">支付宝</h4>
        <p class="weui_media_desc weui_media_desc_size">推荐支付宝用户使用</p>
    </div>
    <div class="weui_cell_ft">
                    <input type="radio" class="weui_check" value="alipay"  name="payway" id="course1" >
                    <span class="weui_icon_checked"></span>
                </div>
</label> 
        </div>-->
        <!--/////////////////////////////////////-->
        <div class="weui_panel_bd">
            <div class="weui_media_box weui_media_text pay_kuang" style="padding-bottom: 0.5rem;">
                <p class="weui_media_desc">支付小贴士</p>
                <p class="weui_media_desc weui_media_desc_size">因跑步赛事的特殊性，报名需以支付款为准，取消不退款，名额无法转让，敬请您谅解。</p>
            </div>
        </div>
        <div class="weui_cells_checkbox">
            <label class="weui_cell weui_check_label weui_check_label_pad" for="s11">
                <div class="weui_cell_bd weui_cell_primary xieyi">
                    <p>同意<a href="agreement" style="padding-left: 0.5357142857142857rem;">《报名须知及服务协议》</a></p>
                </div>
            </label>
        </div>
        <div class="weui_cell weui_cell_bgcolor"><input type="submit" value="立即付款" class="weui_btn weui_btn_warn"></div> 
        <a href="/Enroll?m_id=<{$price.matchid}>" class="pay_question">有问题，请重新选择套餐</a>
    </div>
    </form>
    <!--<div class="flexBox moreWay">
        <div class="flex_1"><a href="/Enroll?m_id=<{$price.matchid}>">有疑问重新选择套餐</a></div>
        <div><a href="/PayResult/fother">更多支付方式</a></div>
    </div>-->
    <div class="bottom">服务由知行和逸提供</div>
</div>
<script type="text/javascript" src="/static/js/zepto.js"></script>
<script src="/static/weui/js/weui.js"></script>
<script type="text/javascript">
var orderid = "";
var auth_code = "<{$auth_code}>";
var issenging = false;
// function agreement1(){
//     $("#agreementBox").show();
// }
// function agreement_hide(){
//     $("#agreementBox").hide();
// }
//调用微信JS api 支付
function jsApiCall()
{
    try{
        weui.Loading.show(); 
        $.ajax({
            url:"/PayResult/payali?orderid="+orderid+"&auth_code="+auth_code,
            type: "POST",
            dataType: "json",
            timeout:'6000',
            data: {},
            success:function(data){
                weui.Loading.hide();  
                if(data.error==0){
                    AlipayJSBridge.call("tradePay",{ tradeNO: data.data}, 
                    function(result){
                        if(result.resultCode==9000){
                            setTimeout(function(){
                                window.location.href = window.location.href;
                            },2000);
                        }
                    });
                }else{
                    weui.alert(data.msg);
                }
                issenging = false;

            },
            error:function(data){
                // weui.confirm("服务器繁忙！过会再试！","提示",function(){
                //     window.location.href = "/PayResult/payorder?orderid="+orderid;
                // });
                weui.Loading.hide(); 
                issenging = false;
            }
        });
    }catch(e){
         weui.Loading.hide(); 
        weui.alert("请在支付宝里打开页面并完成支付！");
    }
}

function callpay()
{
    if (typeof AlipayJSBridge == "undefined"){
        if( document.addEventListener ){
            document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
        }else if (document.attachEvent){
            document.attachEvent('WeixinJSBridgeReady', jsApiCall); 
            document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
        }
        weui.alert("请在支付宝客户端进行支付！");
        jsApiCall();
    }else{
        jsApiCall();
    }
}

$("#payForm").submit(function(){
//  var agreement = $("input[name=agreement]").not(function(){ return !this.checked }).val();
//  if(agreement){
//      weui.alert("您还未同意我们的用户证书！");
//      return false;
//  }
    if(issenging) return false;
    issenging = true;
    orderid = $("input[name=WIDout_trade_no]").val();
    if(!orderid){
        weui.alert("未找到您的订单！");
        return false;
    }
    var payway = $("input[name=payway]").not(function(){ return !this.checked }).val();
    try{
        callpay();
    }catch(e){
        weui.alert("π_π，创建支付遇到问题了！");
    }         
    return false;
});
var m_untilTime = "<{$price.pay_deadline}>";
function getDate(strDate){
    var st = strDate;
    var a = st.split(" ");
    var b = a[0].split("-");
    var c = a[1].split(":");
    var date = new Date(b[0], b[1]-1, b[2], c[0], c[1], c[2])
    return date;
}
function CountDown(){
    var Now =  new Date().getTime();
    var Until =  getDate(m_untilTime).getTime();
    var countS = Math.floor((Until-Now)/1000);
    var html = "00:00:00";
    if(countS>0){
        var hour = Math.floor(countS/3600);
        if(hour>72){
            html = m_untilTime.substr(0,10);
            clearTimeout(CountDownTiming);
        }else{
            var min = Math.floor((countS%3600)/60);
            var sec = (countS%3600)%60;
             html = (hour<10?"0"+hour:hour)+":"+(min<10?"0"+min:min)+":"+(sec<10?"0"+sec:sec);
        }
    }
    if($("#countdown").length>=1){
        $("#countdown").html(html);
    }else{
        clearTimeout(CountDownTiming);
    }
}
var CountDownTiming = setInterval(function(){
    CountDown();
},1000);

</script>
<{elseif $price.paystats == 1}>
<div class="msg msg_pad">
        <div class="weui_msg">
            <div class="weui_icon_area"><i class="weui_icon_success weui_icon_msg"></i></div>
            <div class="weui_text_area">
                <h2 class="weui_msg_title" style="font-size: 1.214285714285714rem;">支付成功</h2>
        <!--         <p class="weui_msg_desc"style="text-align: left;">感谢您的报名，请添加<span class="color_w">客服微信号zxhylv</span>,告知客服您的姓名+比赛名称。我们会在比赛开始前建立微信群，便于跑者们互相交流，以及通报最新消息。比赛前10天向您的邮箱中发送队员手册。如有问题，请致电：4000-842-195。预祝您跑出好成绩！</p> -->
                <p class="weui_msg_desc" style="text-align: left;font-size: 1rem;">感谢您的报名，如有问题请致电400-820-8820， 祝您跑出好成绩！</p>
            </div>
        </div>
        <div class="weui_opr_area">
            <p class="weui_btn_area">
                <a href="/" class="weui_btn weui_btn_default">返回赛事首页</a>
            </p>
        </div>
        <div class="weui_extra_area">
                <a href="/User/order">查看详情</a>
            </div>
    <div class="bottom">服务由知行和逸提供</div>    
</div>
<script type="text/javascript" src="/static/js/zepto.js"></script>
<!-- <script type="text/javascript" src="/static/js/enroll.js"></script> -->
<{else}>
无效定单！
<{/if}>
</body>
</html>
